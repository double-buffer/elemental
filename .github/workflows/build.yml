on:
  workflow_call:
    inputs:
      platform:
        required: true
        type: string
      architecture:
        required: true
        type: string

jobs:
  build:
    runs-on: ${{ 
      (inputs.platform == 'osx' && 'macos-14') ||
      (inputs.platform == 'linux' && 'ubuntu-latest') ||
      (inputs.platform == 'win' && 'windows-latest')
      }}

    steps:
    - uses: actions/checkout@master
      with:
        submodules: recursive

    - name: Setup Windows Dependencies
      if: inputs.platform == 'win'
      uses: TheMrMilchmann/setup-msvc-dev@v3
      with:
        arch: ${{ inputs.architecture }}

    - name: Setup Linux Dependencies
      if: inputs.platform == 'linux'
      run: sudo apt-get update && sudo apt-get install -y libgtk-4-dev

    - name: Setup Ninja
      uses: seanmiddleditch/gha-setup-ninja@master

    #TODO: We don't need to use ninja-multiconfig because we build only in release
    - name: Configure Build
      run: |
        mkdir ./build
        cmake -DCMAKE_EXPORT_COMPILE_COMMANDS=1 -G "Ninja Multi-Config" -B build -S . -DCMAKE_CXX_COMPILER=${{ inputs.platform == 'win' && 'clang-cl' || 'clang++' }} -DCMAKE_C_COMPILER=${{ inputs.platform == 'win' && 'clang-cl' || 'clang' }}

    - name: Build
      run: |
        cmake --build ./build --target Elemental --config Release

    - name: Build Tests
      run: |
        cmake --build ./build --target SystemFunctionsTests --config Release
        cmake --build ./build --target ApplicationTests --config Release
        cmake --build ./build --target GraphicsTests --config Release
          
    - name: Upload Binaries
      uses: actions/upload-artifact@master
      with:
        name: native.bin.${{ inputs.platform }}-${{ inputs.architecture }}
          #path: ./build/bin/Release/*.${{ inputs.platform == 'win' && 'dll' || inputs.platform == 'osx' && 'dylib' || 'so' }}
        path: ./build/bin/Release/

    - name: Upload Tests Binaries
      uses: actions/upload-artifact@master
      with:
        name: native.tests.${{ inputs.platform }}-${{ inputs.architecture }}
        path: |
          ./build/bin/Release/SystemFunctionsTests*
          ./build/bin/Release/ApplicationTests*
          ./build/bin/Release/GraphicsTests*
